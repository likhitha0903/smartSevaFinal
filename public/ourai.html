<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SmartSeva — Smart Grievance Portal</title>
  <link rel="shortcut icon" href="./assets/governance.png" type="image/png">
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <!-- Your global styles -->
    <link rel="stylesheet" href="styles.css" />

    <style>
      :root {
        --primary: #ff671f;
        --secondary: #046a38;
        --accent: #013369;
        --bg: #f3f4f6;
        --text: #1f2937;
        --border: #d1d5db;
      }

      body {
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial,
          sans-serif;
        background: #f3f4f6;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        color: var(--text);
      }

      /* ======== AI HERO SECTION ======== */
      #ai-hero {
        background: radial-gradient(circle at top, #ffffff, #e5edf5);
      }

      .ai-hero-inner {
        max-width: 1100px;
      }

      .ai-hero-title {
        font-weight: 800;
        color: var(--accent);
      }

      .ai-hero-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0.75rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(209, 213, 219, 0.9);
        font-size: 0.8rem;
        color: #4b5563;
      }

      .ai-hero-image-wrapper {
        border-radius: 24px;
        overflow: hidden;
        box-shadow: 0 18px 50px rgba(15, 23, 42, 0.25);
      }

      .ai-hero-image-wrapper img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      /* ======== AI PREDICT SECTION ======== */
      #ai-predict-section {
        background: rgba(255, 255, 255, 0.9);
        border-top: 1px solid var(--border);
      }

      .ai-predict-card {
        border-radius: 20px;
        border: 1px solid rgba(209, 213, 219, 0.9);
        background: rgba(255, 255, 255, 0.95);
        box-shadow: 0 20px 50px rgba(15, 23, 42, 0.15);
        padding: 1.8rem 1.5rem;
        height: 100%; /* same height behaviour as video card */
      }

      .ai-video-card {
        max-width: 100%;
        height: 100%; /* match height with form card */
        border-radius: 12px;
        overflow: hidden;
      }

      .ai-video-wrapper {
        width: 100%;
        height: 100%;
        padding: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .demo-video {
        max-width: 100%;
        max-height: 100%;
        width: auto;
        height: auto;
        object-fit: contain;
        display: block;
      }

      #preview {
        width: 100%;
        max-height: 250px;
        object-fit: cover;
        border-radius: 0.75rem;
      }

      #cameraContainer video {
        width: 100%;
        border-radius: 0.75rem;
      }

      #cameraContainer {
        display: none;
      }

      .form-label {
        font-weight: 600;
        font-size: 0.9rem;
      }

      .form-control,
      .form-select {
        border-radius: 0.75rem;
        border-color: var(--border);
      }
      .form-control:focus,
      .form-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 0.15rem rgba(255, 103, 31, 0.2);
      }

      .btn-primary {
        --bs-btn-bg: var(--primary);
        --bs-btn-border-color: var(--primary);
        --bs-btn-hover-bg: #e65e1d;
        --bs-btn-hover-border-color: #e65e1d;
        border-radius: 0.8rem;
        font-weight: 600;
      }

      .btn-outline-secondary {
        border-radius: 0.8rem;
      }

      #aiResult {
        border-radius: 0.9rem;
      }
      .photo-label {
  position: absolute;
  top: 6px;
  left: 6px;
  background: rgba(0,0,0,0.65);
  color: #fff;
  padding: 3px 8px;
  font-size: 0.75rem;
  font-weight: 600;
  border-radius: 6px;
}
.photo-wrapper {
  position: relative;
  width: 100%;
}


    </style>
  </head>
  <body>
<!-- SMARTSEVA GLOBAL NAVBAR -->
<nav class="navbar navbar-expand-md navbar-light bg-white sticky-top shadow-sm">
  <div class="container-fluid">

    <!-- LEFT: Brand -->
    <a class="navbar-brand d-flex align-items-center gap-2" href="index.html#home">
      <img src="./assets/icon.png"
           width="150" height="50" alt="SmartSeva" style="border-radius:8px;object-fit:cover;">
    </a>

    <!-- Mobile Toggler -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"
            aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- CENTER + RIGHT -->
    <div class="collapse navbar-collapse" id="mainNav">

      <!-- CENTER: main links -->
      <ul class="navbar-nav mx-auto mb-2 mb-md-0">
        <li class="nav-item">
          <a class="nav-link mx-3" href="index.html#home">Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link me-3" href="aboutUs.html">About Us</a>
        </li>
        <li class="nav-item">
          <a class="nav-link me-3" href="./ourai.html">
           OUR AI
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link me-3" href="dashboard.html">Dashboard</a>
        </li>
        <li class="nav-item">
          <a class="nav-link me-3" href="contactUs.html">Contact Us</a>
        </li>
      </ul>

      <!-- RIGHT: language + auth -->
      <div class="d-flex align-items-center gap-2 ms-md-0 ms-auto">

        <!-- Language dropdown -->
        <!-- <div class="dropdown">
          <button class="btn btn-light border dropdown-toggle py-1 px-2"
                  id="langDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            Language
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="langDropdown">
            <li><button class="dropdown-item" type="button">English</button></li>
            <li><button class="dropdown-item" type="button">हिंदी</button></li>
            <li><button class="dropdown-item" type="button">తెలుగు</button></li>
          </ul>
        </div> -->
       <!-- AUTH AREA -->
      <div class="ms-1">

  <div id="navAuthLoggedOut" class="dropdown">
    <button class="btn btn-outline-primary dropdown-toggle py-1 px-3"
            type="button" data-bs-toggle="dropdown">
      Login
    </button>
    <ul class="dropdown-menu dropdown-menu-end">
      <li><a class="dropdown-item" href="login.html">User Login</a></li>
      <li><hr class="dropdown-divider"></li>
      <li><a class="dropdown-item" href="adminlogin.html">Admin Login</a></li>
    </ul>
  </div>

  <div id="navAuthLoggedIn" class="dropdown d-none">
    <button class="btn btn-light dropdown-toggle d-flex align-items-center gap-2 py-1 px-2"
            type="button" data-bs-toggle="dropdown">

      <div id="navUserAvatar"
           class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center"
           style="width:32px;height:32px;font-size:.9rem;font-weight:700;">
        U
      </div>

      <span id="navUserName" class="small fw-semibold">User</span>
    </button>

    <ul class="dropdown-menu dropdown-menu-end">
      <li><a class="dropdown-item" href="profile.html">Profile</a></li>
      <li><a class="dropdown-item" href="dashboard.html">My Complaints</a></li>
      <li><hr class="dropdown-divider"></li>
      <li><button class="dropdown-item text-danger" id="btnNavLogout">Logout</button></li>
    </ul>
  </div>

</div>

      </div>
    </div>
  </div>
</nav>

<!-- TOAST CONTAINER -->
<div class="toast-container position-fixed top-20 start-50 translate-middle-x p-3">
  <div id="smartToast" class="toast align-items-center text-bg-primary border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="toastMessage">
        <!-- Message goes here -->
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>


    <main class="flex-grow-1">
      <!-- =============== AI HERO (shown first) =============== -->
      <section id="ai-hero" class="py-5">
        <div class="container ai-hero-inner">
          <div class="row align-items-center g-4">
            <!-- Left: image -->
            <div class="col-md-6">
              <div class="ai-hero-image-wrapper me-5">
                <!-- Replace src with your AI illustration -->
                <img
                  src="./assets/ourai.jpeg"
                  alt="SmartSeva AI analysing complaints"
                />
              </div>
            </div>

            <!-- Right: text -->
            <div class="col-md-6">
              <div class="ai-hero-tag mb-3">
                <i class="bi bi-cpu-fill"></i>
                <span>SmartSeva AI · Pilot Preview</span>
              </div>
              <h1 class="ai-hero-title mb-3 heading">
                Let our AI understand your grievance in seconds.
              </h1>
              <p class="mb-3 text-muted">
                SmartSeva is an AI-powered grievance detection system that
                identifies civic issues from uploaded images, recognizing
                problems like garbage, road damage, or child-related concerns
                while also predicting their severity. It provides accurate,
                confidence-based results that reduce manual verification for
                authorities. With quick image analysis and automatic department
                suggestions, SmartPraja improves transparency, speeds up
                response times, and helps officials prioritize urgent and
                genuine complaints..
              </p>
              <p class="mb-4 text-muted">
                You stay in control — the final complaint is always filed in
                your name, with full transparency.
              </p>
              <button id="btnTryModel" class="btn btn-primary btn-lg">
                Try our AI Model
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- =============== AI PREDICT + RAISE COMPLAINT (hidden until click) =============== -->
      <section id="ai-predict-section" class="py-5 d-none">
        <div class="container">
          <div class="mb-4 text-center">
            <h2 class="h1 fw-extrabold brand-text">
              SmartSeva AI · Grievance Assistant
            </h2>
            <p class="text-muted mb-0">
              Describe your issue once. Our AI will estimate severity and you
              can submit directly to SmartSeva.
            </p>
          </div>

          <!-- CHANGED align-items-start -> align-items-stretch for equal height cols -->
          <div class="row g-4 align-items-stretch">
            <!-- LEFT: Form + AI prediction -->
            <div class="col-md-6">
              <!-- added h-100 -->
              <div class="ai-predict-card h-100">
                <h5 class="mb-3 fw-bold text-primary">
                  Raise a Grievance with AI Assistance
                </h5>

                <form id="complaintForm" novalidate>
                  <!-- Upload Image / Camera -->
                  <div class="mb-3">
                    <label class="form-label">Upload Image (or capture)</label>
                    <div class="d-flex align-items-center gap-2 mb-5">
                      <button
                        type="button"
                        id="fileBtn"
                        class="btn btn-primary btn-sm"
                      >
                        <i class="bi bi-upload me-1"></i>Choose a file
                      </button>
                      <button
                        type="button"
                        id="cameraBtn"
                        class="btn btn-outline-secondary btn-sm"
                      >
                       <i class="bi bi-camera"></i>
                      </button>
                    </div>
                    <input
                      type="file"
                      id="photoInput"
                      accept="image/*"
                      class="d-none"
                    />
                    <div id="cameraContainer" class="mb-2">
                      <video id="camera" autoplay></video>
                      <button
                        type="button"
                        id="captureBtn"
                        class="btn btn-danger btn-sm mt-2"
                      >
                        Capture Photo
                      </button>
                    </div>
                    <img id="preview" class="d-none mt-2" alt="Preview" />
                  </div>

                  <!-- Description -->
                  <div class="mb-3">
                    <label class="form-label" for="description"
                      >Short Description</label
                    >
                    <textarea
                      id="description"
                      class="form-control"
                      style="resize: none"
                      rows="2"
                      placeholder="Describe the problem briefly..."
                    ></textarea>
                  </div>

                  <!-- Category (your dropdown) -->
                  <div class="mb-3">
                    <label class="form-label" for="category">Category</label>
                    <select id="category" class="form-select" required>
                      <option value="" disabled selected>
                        Select Category
                      </option>
                      <option value="Road Issue">Road Issue</option>
                      <option value="Child Labour">Child Labour</option>
                      <option value="Drainage Issue">Garbage Issue</option>
                    </select>
                  </div>

                  <!-- Location -->
                  <div class="mb-3">
                    <label class="form-label" for="manualLocation"
                      >Location</label
                    >
                    <input
                      type="text"
                      id="manualLocation"
                      class="form-control"
                      placeholder="Type locality / street / landmark"
                      required
                    />
                    <small class="text-muted">
                      If location access is blocked, please type it manually.
                    </small>
                  </div>

                  <!-- Buttons -->
                  <div class="d-flex flex-wrap gap-2 mt-3">
                    <button
                      type="submit"
                      class="btn btn-success"
                      id="btnSubmitComplaint"
                    disabled>
                      Submit Grievance
                    </button>
                    <button
                      type="button"
                      class="btn btn-outline-secondary"
                      id="btnPredict"
                    >
                      <i class="bi bi-magic me-1"></i>Predict Severity
                    </button>
                  </div>
                </form>

                <!-- AI Result box -->
                <div id="aiResult" class="alert alert-info mt-4 d-none">
                  <strong><span><i class="bi bi-robot"></i></span>AI Prediction:</strong>
                  <div class="mt-1 small" id="aiResultContent"></div>
                </div>
                <div id="categoryError" class="alert alert-danger mt-3 d-none">
  Please specify the correct category.
</div>

              </div>
            </div>

            <!-- RIGHT: Video instead of Map -->
<div class="col-md-6">
  <div class="video-card mb-3">
    <div class="video-frame">
      <video autoplay muted loop playsinline>
        <source src="./assets/Process.mp4" type="video/mp4" />
      </video>
    </div>

    <div class="video-label">Demo view: how SmartSeva AI reads complaints,<br> identifies risk, and
              suggests priority.</div>
  </div>
</div>
            <!-- <p class="small text-muted mt-2">
              Demo view: how SmartSeva AI reads complaints, identifies risk, and
              suggests priority.
            </p> -->
          </div>
        </div>
      </section>
    </main>

<!-- FOOTER -->
<footer id="contact" class="smart-footer mt-auto">
  <div class="container-lg  py-5">

    <div class="row g-4 align-items-start">

      <!-- Brand + tagline -->
      <div class="col-md-4">
        <div class="d-flex align-items-center gap-0 mb-3">
          <div class=" d-flex align-items-center justify-content-center"></div>
          <div>
            <div class="fw-bold smart-footer-title">SmartSeva</div>
            <div class="small text-muted">Citizen–first grievance platform</div>
          </div>
        </div>
        <p class="small text-muted mb-3">
          Close the loop between citizens and departments with<br> transparent, time-bound grievance resolution.
        </p>

        <!-- Mini "status" pills -->
        <div class="d-flex flex-wrap gap-2">
          <span class="badge smart-footer-pill">
            <i class="bi bi-lightning-charge-fill me-1"></i> Real-time Tracking
          </span>
          <span class="badge smart-footer-pill">
            <i class="bi bi-shield-check me-1"></i> Verified Complaints
          </span>
        </div>
      </div>

      <!-- Quick Nav -->
      <div class="col-6 col-md-2">
        <h6 class="smart-footer-heading mb-3">Navigate</h6>
        <ul class="list-unstyled m-0 smart-footer-links">
          <li><a href="./index.html">Home</a></li>
          <li><a href="./aboutUs.html">About Us</a></li>
          <li><a href="./ourai.html">OUR AI</a></li>
          <li><a href="./dashboard.html">Dashboard</a></li>
          <li><a href="./contactUs.html">Contact</a></li>
        </ul>
      </div>

      <!-- Support -->
      <div class="col-6 col-md-3">
        <h6 class="smart-footer-heading mb-3">Support</h6>
        <ul class="list-unstyled m-0 smart-footer-links">
          <li><a href="#">Help & FAQs</a></li>
          <!-- <li><a href="#">How SmartSeva Works</a></li> -->
          <li><a href="#">Citizen Charter</a></li>
          <!-- <li><a href="#">Data & Privacy</a></li> -->
        </ul>

        <div class="mt-3 small text-muted">
          Email: <a href="mailto:smartsevaforpeople@gmail.com" class="smart-footer-inline-link">smartsevaforpeople@gmail.com</a><br>
          Helpline: 1800-000-000
        </div>
      </div>

      <!-- Newsletter + social -->
      <div class="col-md-3">
        <h6 class="smart-footer-heading mb-3">Stay in the loop</h6>
        <p class="small text-muted mb-2">
          Get updates on new features, dashboards and citizen tools.
        </p>

        <form class="smart-footer-form mb-3">
          <div class="input-group">
            <input type="email" class="form-control smart-footer-input"
                   placeholder="Enter your email" aria-label="Email">
            <button class="btn smart-footer-btn" type="button">
              <i class="bi bi-send-fill"></i>
            </button>
          </div>
        </form>

        <div class="d-flex align-items-center gap-2 small text-muted mb-2">
          <span>Follow:</span>
          <div class="d-flex gap-2">
            <a href="#" class="smart-footer-icon"><i class="bi bi-linkedin"></i></a>
            <a href="#" class="smart-footer-icon"><i class="bi bi-twitter-x"></i></a>
            <a href="#" class="smart-footer-icon"><i class="bi bi-instagram"></i></a>
          </div>
        </div>
      </div>

    </div>

    <!-- Bottom strip -->
    <div class="smart-footer-bottom mt-4 pt-3 d-flex flex-column flex-md-col justify-content-center align-items-center gap-2">
      <div class="small text-muted">
        © 2025 SmartSeva. All rights reserved.
      </div>
      <div class="d-flex gap-3 small smart-footer-links m-0">
        <a href="#">Privacy Policy</a>
        <a href="#">Terms of Use</a>
        <a href="#">Accessibility</a>
      </div>
    </div>

  </div>
</footer>

    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script src="app.js"></script>
 

 <script>
    // ====== SECTION TOGGLE: hero -> predict ======
const heroSection = document.getElementById("ai-hero");
const predictSection = document.getElementById("ai-predict-section");
const btnTryModel = document.getElementById("btnTryModel");

async function checkLogin() {
  try {
    const resp = await fetch("http://localhost:9654/api/user/current", {
      credentials: "include"
    });

    if (!resp.ok) return false;

    const data = await resp.json();
    return data.status === "ok";
  } catch (err) {
    return false;
  }
}

function showToast(message, type = "primary") {
  const toastEl = document.getElementById("smartToast");
  const toastBody = document.getElementById("toastMessage");

  toastBody.textContent = message;

  // change colors
  toastEl.className = `toast text-bg-${type} border-0`;

  const toast = new bootstrap.Toast(toastEl);
  toast.show();
}


if (btnTryModel) {
  btnTryModel.addEventListener("click", async () => {

    const loggedIn = await checkLogin();

    if (!loggedIn) {
      // alert("Please login to use SmartSeva AI.");
      showToast("Please login to use SmartSeva AI", "warning");
      // window.location.href = "login.html";
      setTimeout(() => {
  window.location.href = "login.html";
}, 2000);
      return;
    }

    // ✔ Show model only if logged in
    heroSection.classList.add("d-none");
    predictSection.classList.remove("d-none");
    predictSection.scrollIntoView({ behavior: "smooth", block: "start" });
  });
}


// ====== IMAGE / CAMERA HANDLING ======
const fileBtn = document.getElementById("fileBtn");
const photoInput = document.getElementById("photoInput");
const cameraBtn = document.getElementById("cameraBtn");
const cameraContainer = document.getElementById("cameraContainer");
const cameraVideo = document.getElementById("camera");
const captureBtn = document.getElementById("captureBtn");
const previewImg = document.getElementById("preview");
const locationInput = document.getElementById("manualLocation");
const btnSubmitComplaint = document.getElementById("btnSubmitComplaint");

let cameraStream = null;
let aiPredictedCategory = null;
let aiPredictedSeverity = null; // <-- NEW: store AI severity

// Automatic Location (GPS) with reverse geocoding
function getUserLocation() {
  if (!navigator.geolocation || !locationInput) return;

  navigator.geolocation.getCurrentPosition((pos) => {
    const { latitude: lat, longitude: lng } = pos.coords;

    fetch(
      `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`
    )
      .then((res) => res.json())
      .then((data) => {
        if (!locationInput.value.trim()) {
          locationInput.value =
            data.display_name ||
            `Lat ${lat.toFixed(4)}, Lng ${lng.toFixed(4)}`;
        }
      })
      .catch((err) => {
        console.error("Reverse geocode error:", err);
        if (!locationInput.value.trim()) {
          locationInput.value = `Lat ${lat.toFixed(4)}, Lng ${lng.toFixed(4)}`;
        }
      });
  });
}

function stopCamera() {
  if (cameraStream) {
    cameraStream.getTracks().forEach((t) => t.stop());
    cameraStream = null;
  }
}

// File button
if (fileBtn && photoInput) {
  fileBtn.addEventListener("click", () => {
    stopCamera();
    if (cameraContainer) cameraContainer.style.display = "none";
    photoInput.click();
  });

  photoInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      previewImg.src = ev.target.result;
      previewImg.classList.remove("d-none");
    };
    reader.readAsDataURL(file);

    getUserLocation();
  });
}

// Camera button
if (cameraBtn && cameraContainer && cameraVideo) {
  cameraBtn.addEventListener("click", async () => {
    cameraContainer.style.display = "block";
    try {
      cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
      cameraVideo.srcObject = cameraStream;
    } catch (err) {
      alert("Camera access blocked. Please allow camera or upload a photo.");
      cameraContainer.style.display = "none";
    }
  });
}

// Capture photo
if (captureBtn && cameraVideo) {
  captureBtn.addEventListener("click", () => {
    const canvas = document.createElement("canvas");
    canvas.width = cameraVideo.videoWidth;
    canvas.height = cameraVideo.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(cameraVideo, 0, 0);
    const dataUrl = canvas.toDataURL("image/png");

    previewImg.src = dataUrl;
    previewImg.classList.remove("d-none");

    stopCamera();
    cameraContainer.style.display = "none";

    getUserLocation();
  });
}

// ====== AI PREDICTION ======
const btnPredict = document.getElementById("btnPredict");
const aiResultBox = document.getElementById("aiResult");
const aiResultContent = document.getElementById("aiResultContent");
const categoryError = document.getElementById("categoryError");
const categoryEl = document.getElementById("category");

if (btnPredict && aiResultBox && aiResultContent) {
  btnPredict.addEventListener("click", async () => {
    let file = photoInput.files[0];
    if (!file && previewImg.src.startsWith("data:image")) {
      const response = await fetch(previewImg.src);
      const blob = await response.blob();
      file = new File([blob], "captured.png", { type: "image/png" });
    }
    if (!file) {
      alert("Please upload or capture an image first.");
      return;
    }

    const formData = new FormData();
    formData.append("file", file);

    aiResultBox.classList.remove("d-none");
    aiResultContent.innerHTML = "⏳ Processing image... please wait.";

    try {
      const resp = await fetch("http://localhost:9654/api/predict", {
        method: "POST",
        body: formData
      });
      const data = await resp.json();

      const main = data.main_output;
      const severity = data.severity_output;

      const mainMaxIndex = main.indexOf(Math.max(...main));
      const severityMaxIndex = severity.indexOf(Math.max(...severity));

      const mainLabels = ["Garbage", "Road Issue", "Drainage Issue"];
      const severityLabels = ["Low", "Medium", "High"];

      aiPredictedCategory = mainLabels[mainMaxIndex];
      aiPredictedSeverity = severityLabels[severityMaxIndex]; // <-- NEW

      const userSelectedCategory = categoryEl.value;

      if (btnSubmitComplaint) btnSubmitComplaint.disabled = false;

      if (categoryError) {
        if (aiPredictedCategory === userSelectedCategory) categoryError.classList.add("d-none");
        else categoryError.classList.remove("d-none");
      }

    aiResultContent.innerHTML = `
  <div class="ai-result-card">
      <div class="ai-result-title">
        
      </div>

      <div class="ai-result-item">
        <b>Category:</b> 
        <span>${aiPredictedCategory}</span>
        <span class="text-muted small">(${(main[mainMaxIndex] * 100).toFixed(2)}%)</span>
      </div>

      <div class="ai-result-item">
        <b>Severity:</b> 
        <span class="
          ${aiPredictedSeverity === 'High' ? 'severity-high' : ''} 
          ${aiPredictedSeverity === 'Medium' ? 'severity-medium' : ''} 
          ${aiPredictedSeverity === 'Low' ? 'severity-low' : ''}
        ">
          ${aiPredictedSeverity}
        </span>
        <span class="text-muted small">(${(severity[severityMaxIndex] * 100).toFixed(2)}%)</span>
      </div>

      <div class="ai-result-item mt-2">
        ${aiPredictedCategory === userSelectedCategory 
          ? '<span style="color: green;">✅ Category matches your selection</span>'
          : '<span style="color: orange;">⚠️ Category differs from your selection</span>'}
      </div>
  </div>
`;
    } catch (err) {
      aiResultContent.innerHTML = `<span class="text-danger">❌ Error: Could not connect to backend.<br>${err}</span>`;
      aiPredictedCategory = null;
      aiPredictedSeverity = null;
    }
  });
}

// ====== FORM SUBMIT ======
const complaintForm = document.getElementById("complaintForm");
const descriptionEl = document.getElementById("description");

if (complaintForm) {
  complaintForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const description = descriptionEl.value.trim();
    const userCategory = categoryEl.value;
    const location = locationInput.value.trim();
    const file = photoInput.files[0];
    const previewSrc = previewImg.src || "";

    const hasUploaded = !!file;
    const hasCaptured = previewSrc.startsWith("data:image");

    if (!hasUploaded && !hasCaptured) { alert("Please upload an image or capture a photo."); return; }
    if (!userCategory) { alert("Please select a category."); return; }
    if (!location) { alert("Please enter a location."); return; }
    if (!aiPredictedSeverity) { alert("Please get AI severity prediction first."); return; } // <-- NEW

    if (aiPredictedCategory && userCategory !== aiPredictedCategory) {
        alert(
    `Warning: Your selected category (${userCategory}) doesn't match the AI prediction (${aiPredictedCategory}).`
  );
  return; 
    }

    // ====== Upload image first ======
    let imageUrl = "";
    try {
      let uploadFile = hasUploaded ? file : await (await fetch(previewSrc)).blob();
      const formData = new FormData();
      formData.append("file", uploadFile);

      const uploadResp = await fetch("http://localhost:9654/api/complaints/upload", {
        method: "POST",
        body: formData
      });
      const uploadData = await uploadResp.json();
      imageUrl = uploadData.url || "";
    } catch (err) {
      console.error("Image upload failed:", err);
      alert("Image upload failed. Try again.");
      return;
    }

    // ====== Submit complaint ======
    const complaintData = {
      category: userCategory,
      description: description || "No description provided",
      location,
      imageUrl,
      severity: aiPredictedSeverity // <-- SEND AI severity
    };

    try {
      const response = await fetch("http://localhost:9654/api/complaints/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(complaintData),
         credentials: "include",
      });

      if (response.ok) {
        // alert("Complaint submitted successfully!");
        showToast("Complaint submitted successfully!", "success");

        // Reset form
        complaintForm.reset();
        previewImg.classList.add("d-none");
        previewImg.src = "";
        photoInput.value = "";
        aiResultBox.classList.add("d-none");
        categoryError.classList.add("d-none");
        if (btnSubmitComplaint) btnSubmitComplaint.disabled = true;
        aiPredictedCategory = null;
        aiPredictedSeverity = null; // <-- RESET
      } else {
        throw new Error("Failed to submit complaint");
      }
    } catch (error) {
      console.error("Error submitting complaint:", error);
      alert("Error submitting complaint. Please try again.");
    }
  });
}

// Stop camera when leaving page
window.addEventListener("beforeunload", stopCamera);

  </script>
</body>

</html>